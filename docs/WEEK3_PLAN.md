# Week 3 优化计划

**目标：** 完成剩余 P0 和 P1 任务，准备公测

**时间：** 2025-10-13 ~ 2025-10-19（7天）

**当前状态：** 62/100 → 目标：75/100 ✨

---

## 📋 本周任务清单

### 🔴 P0 - 必须完成（高优先级）

#### 1. Cookie 同意弹窗 ⏰ 预计：3小时
**重要性：** GDPR/CCPA 合规要求

**任务：**
- [ ] 安装 `react-cookie-consent` 或实现自定义组件
- [ ] 创建 Cookie Banner 组件
- [ ] 实现接受/拒绝逻辑
- [ ] 记录用户同意状态
- [ ] 根据同意状态控制 Analytics 加载
- [ ] 创建 Cookie 政策页面（/legal/cookies）

**验收标准：**
- ✅ 首次访问显示 Cookie 弹窗
- ✅ 用户可以接受或拒绝 Cookie
- ✅ 拒绝后不加载分析脚本
- ✅ Cookie 政策页面完整

---

#### 2. Rate Limiting 中间件 ⏰ 预计：4小时
**重要性：** 防止 API 滥用和 DDoS 攻击

**任务：**
- [ ] 安装 `rate-limiter-flexible`
- [ ] 创建 Rate Limiting 中间件
- [ ] 应用到所有 API Routes
- [ ] 配置不同端点的限流规则
- [ ] 添加超限错误提示
- [ ] 测试限流功能

**验收标准：**
- ✅ API 请求超限返回 429 状态码
- ✅ 错误提示友好清晰
- ✅ 不同 API 有不同限制（登录更严格）

**限流规则建议：**
```typescript
- GET /api/scores: 60 次/分钟
- POST /api/scores: 20 次/分钟
- POST /api/scores/[id]: 30 次/分钟
- 认证端点: 10 次/分钟
```

---

#### 3. 用户数据删除功能 ⏰ 预计：4小时
**重要性：** GDPR "被遗忘权" 要求

**任务：**
- [ ] 创建 DELETE /api/user 端点
- [ ] 实现级联删除（用户 + 所有乐谱）
- [ ] 添加用户设置页面
- [ ] 实现数据删除 UI
- [ ] 添加二次确认对话框
- [ ] 注销并清除会话
- [ ] 更新隐私政策链接

**验收标准：**
- ✅ 用户可以在设置中删除账户
- ✅ 删除前有明确警告和二次确认
- ✅ 删除后立即注销
- ✅ 数据库中用户和相关数据全部删除

---

### 🟠 P1 - 本周完成（中优先级）

#### 4. 全局错误边界 ⏰ 预计：2小时

**任务：**
- [ ] 安装 `react-error-boundary`
- [ ] 创建自定义错误边界组件
- [ ] 设计降级 UI
- [ ] 集成 Sentry 错误上报
- [ ] 包裹根组件和关键组件

**验收标准：**
- ✅ 组件渲染错误不会导致白屏
- ✅ 显示友好的错误提示
- ✅ 提供"重新加载"按钮
- ✅ 错误自动上报到 Sentry

---

#### 5. 性能优化 - 第一阶段 ⏰ 预计：6小时

**任务 A：图片优化**
- [ ] 转换静态指法图为 WebP 格式
- [ ] 实现图片懒加载
- [ ] 添加图片占位符
- [ ] 优化图片尺寸（响应式）

**任务 B：Service Worker（可选，时间允许）**
- [ ] 创建基础 Service Worker
- [ ] 配置静态资源缓存
- [ ] 实现离线提示

**任务 C：代码分割**
- [ ] 分析 script.js 大小
- [ ] 拆分为多个模块（如果可行）
- [ ] 动态导入非关键代码

**验收标准：**
- ✅ Lighthouse Performance 分数 > 80
- ✅ 首屏加载时间 < 3秒
- ✅ 图片懒加载正常工作

---

#### 6. 用户数据导出功能 ⏰ 预计：3小时
**重要性：** GDPR 数据可移植权

**任务：**
- [ ] 创建 GET /api/user/export 端点
- [ ] 导出用户所有数据为 JSON
- [ ] 添加"导出数据"按钮到设置页面
- [ ] 生成下载链接
- [ ] 更新隐私政策

**验收标准：**
- ✅ 用户可以下载包含所有数据的 JSON 文件
- ✅ 数据格式清晰易读
- ✅ 包含用户信息和所有乐谱

---

### 🟢 P2 - 如果时间允许（低优先级）

#### 7. Cookie 政策独立页面 ⏰ 预计：2小时
- [ ] 创建 /legal/cookies 页面
- [ ] 详细说明使用的 Cookie 类型
- [ ] 解释 Cookie 用途
- [ ] 提供管理 Cookie 的方法

#### 8. 健康检查端点 ⏰ 预计：1小时
- [ ] 创建 /api/health 端点
- [ ] 检查数据库连接
- [ ] 检查关键服务状态
- [ ] 返回 JSON 状态报告

---

## 📊 进度追踪

| 任务 | 优先级 | 预计时间 | 实际时间 | 状态 | 完成日期 |
|------|--------|----------|----------|------|----------|
| Cookie 同意弹窗 | P0 | 3h | - | ⏳ Pending | - |
| Rate Limiting | P0 | 4h | - | ⏳ Pending | - |
| 数据删除功能 | P0 | 4h | - | ⏳ Pending | - |
| 全局错误边界 | P1 | 2h | - | ⏳ Pending | - |
| 图片优化 | P1 | 4h | - | ⏳ Pending | - |
| 数据导出功能 | P1 | 3h | - | ⏳ Pending | - |
| Cookie 政策页面 | P2 | 2h | - | ⏳ Pending | - |
| 健康检查端点 | P2 | 1h | - | ⏳ Pending | - |
| **总计** | - | **23h** | - | - | - |

---

## 🎯 本周目标

### 量化指标
- ✅ **综合评分：** 62/100 → 75/100 (+13分)
- ✅ **P0 任务完成率：** 85% → 100%
- ✅ **P1 任务完成率：** 72% → 95%
- ✅ **Lighthouse 性能分数：** > 80

### 质量指标
- ✅ 所有 P0 安全和合规问题解决
- ✅ 用户体验评分达到 9/10
- ✅ 法律合规评分达到 8/10
- ✅ 性能优化评分达到 7/10

---

## 📅 每日计划

### Day 1（周一）
- **上午：** Cookie 同意弹窗（3h）
- **下午：** Rate Limiting 中间件（4h）

### Day 2（周二）
- **上午：** 用户数据删除功能（4h）
- **下午：** 全局错误边界（2h）+ Cookie 政策页面（2h）

### Day 3（周三）
- **全天：** 图片优化 + 性能调优（6h）

### Day 4（周四）
- **上午：** 用户数据导出功能（3h）
- **下午：** 健康检查端点 + 其他优化（3h）

### Day 5（周五）
- **全天：** 测试、修复 Bug、文档更新

### Day 6-7（周末）
- **缓冲时间：** 处理遗留问题、准备下周任务

---

## 🚀 下周预告（Week 4）

如果本周顺利完成，下周将进入 **公测准备阶段**：

1. **测试覆盖**
   - 添加单元测试
   - API 集成测试
   - 关键路径 E2E 测试

2. **用户文档**
   - 使用教程
   - FAQ 完善
   - 视频演示录制

3. **监控增强**
   - Vercel Analytics 集成
   - Web Vitals 追踪
   - 自定义事件埋点

4. **性能优化 - 第二阶段**
   - Service Worker 完善
   - 数据库索引优化
   - API 响应缓存

---

## ✅ 成功标准

本周结束时，项目应该满足：

1. **合规性 ✅**
   - GDPR/CCPA 基本合规
   - Cookie 同意机制完善
   - 用户数据权利可执行

2. **安全性 ✅**
   - 所有 API 有 Rate Limiting
   - 输入验证完整
   - 错误处理健壮

3. **性能 ✅**
   - Lighthouse 分数 > 80
   - 首屏加载 < 3s
   - 图片优化完成

4. **用户体验 ✅**
   - 错误不会导致崩溃
   - 反馈及时友好
   - 功能完整可用

**完成后：项目具备公测条件！** 🎉

---

**创建时间：** 2025-10-12  
**负责人：** 开发团队  
**审查周期：** 每日 Stand-up + 周五总结

